name: 1. Veri ve Tarih GÃ¼ncelleme

on:
  schedule:
    # Haftada bir: Pazar gecesi 01:30'da Ã§alÄ±ÅŸÄ±r
    - cron: '30 1 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest
    
    steps:
      - name: Depoyu Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Tag kontrolÃ¼ iÃ§in ÅŸart

      - name: Kontrol ve GÃ¼ncelleme
        run: |
          # 1. data.json yoksa oluÅŸtur
          if [ ! -f data.json ]; then echo '{"version": "1.0"}' > data.json; fi
          
          # 2. Versiyonu Oku
          VERSION=$(jq -r .version data.json)
          echo "Ä°ncelenen SÃ¼rÃ¼m: $VERSION"
          
          # 3. BU SÃœRÃœM ZATEN YAYINDA MI? (Kritik Nokta)
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "ğŸ›‘ SÃ¼rÃ¼m v$VERSION zaten yayÄ±nlanmÄ±ÅŸ."
            echo "ğŸ“… Tarih gÃ¼ncellenmeyecek (Orijinal Ã§Ä±kÄ±ÅŸ tarihi korunuyor)."
            echo "no_update=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # --- Buradan sonrasÄ± SADECE YENÄ° SÃœRÃœMSE Ã§alÄ±ÅŸÄ±r ---
          echo "âœ… Yeni sÃ¼rÃ¼m tespit edildi. Veriler gÃ¼ncelleniyor..."
          
          # 4. BOYUT HESAPLAMA (GeÃ§ici Zip ile)
          cd Chrome
          zip -r ../Chrome_temp.zip . -x "Simple Version/*" -x "*.git*" > /dev/null
          cd ..
          # Boyut hesabÄ± (Ã–rn: 23.1 KB)
          FILE_SIZE=$(python3 -c "import os; s=os.path.getsize('Chrome_temp.zip'); print(f'{s/1024:.1f} KB' if s < 1024*1024 else f'{s/(1024*1024):.1f} MB')")
          rm Chrome_temp.zip
          
          # 5. TARÄ°HÄ° "BUGÃœN" YAP (Ã‡Ã¼nkÃ¼ bugÃ¼n yayÄ±nlÄ±yoruz)
          DATE_EN=$(date +"%b %Y")
          FULL_DATE_EN=$(date +"%b %d, %Y")
          
          m=$(date +%m); Y=$(date +%Y); d=$(date +%d)
          case $m in
            01) M="Ocak";; 02) M="Åubat";; 03) M="Mart";; 04) M="Nisan";; 05) M="MayÄ±s";; 06) M="Haziran";;
            07) M="Temmuz";; 08) M="AÄŸustos";; 09) M="EylÃ¼l";; 10) M="Ekim";; 11) M="KasÄ±m";; 12) M="AralÄ±k";;
          esac
          DATE_TR="$M $Y"
          FULL_DATE_TR="$d $M $Y"
          
          # 6. ZIP LINKINI AYARLA (CRX'e dokunma)
          REPO="KerimDemirkaynak/anime-redirector"
          LINK_ZIP="https://github.com/$REPO/releases/download/v$VERSION/Chrome.zip"
          
          # 7. JSON GÃœNCELLEME
          # Dikkat: .downloads.chromeCrx YOK. O satÄ±r korunur.
          jq --arg den "$DATE_EN" \
             --arg dtr "$DATE_TR" \
             --arg fden "$FULL_DATE_EN" \
             --arg fdtr "$FULL_DATE_TR" \
             --arg czip "$LINK_ZIP" \
             --arg fsize "$FILE_SIZE" \
             '.size = $fsize | .updateDate.en = $den | .updateDate.tr = $dtr | .updateDate.fullDateEn = $fden | .updateDate.fullDateTr = $fdtr | .downloads.chromeZip = $czip' \
             data.json > data.tmp && mv data.tmp data.json
             
          echo "ğŸ’¾ data.json gÃ¼ncellendi (Boyut: $FILE_SIZE, Tarih: $FULL_DATE_TR)"

      - name: DeÄŸiÅŸiklikleri Kaydet (Commit & Push)
        # Sadece yukarÄ±daki adÄ±mda gÃ¼ncelleme yapÄ±ldÄ±ysa Ã§alÄ±ÅŸÄ±r
        if: env.no_update != 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status -s data.json) ]]; then
            git add data.json
            git commit -m "ğŸ”– SÃ¼rÃ¼m v$(jq -r .version data.json) iÃ§in veriler gÃ¼ncellendi"
            git push
            echo "ğŸš€ data.json yÃ¼klendi. Åimdi 'publish-release' dosyasÄ± devreye girecek."
          else
            echo "ğŸ’¤ DeÄŸiÅŸiklik yok."
          fi
